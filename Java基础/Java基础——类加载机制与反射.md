# 类加载机制与反射

## 类的加载、连接和初始化

### Java和类
当Java程序运行时，会启动一个JVM进程，而程序中的所有变量，都会在JVM进程的内存区里，当JVM进程被终止时，该内存区里的所有变量都将被丢弃。

### JVM进程终止
当在以下几种情况时，JVM进程将被终止。
- 程序运行到最好正常结束。
- 程序运行到使用`System.exit()`或`Runtime.getRuntime().exit()`代码处结束程序。
- 程序执行过程中遇到未捕获的异常或错误而结束。
- 程序所在平台强制结束了JVM进程。

### 类的加载
类的加载：当在程序中需要用到某个类，而这个类又没有被加载到内存中时，系统会通过**加载**、**连接**、**初始化**三个步骤来对该类进行初始化。**正常情况下**这三个步骤是依次连续完成的，所以这三个步骤也被统称为**类加载**或**类初始化**。类的加载就是将class文件读入到内存，并为之创建一个`java.lang.Class`对象，也就是说，当程序中使用任何类时，系统都会为之创建一个`java.lang.Class`对象。

### 类加载器
类的加载由类加载器完成，通常类加载器是有JVM提供的，这些JVM提供的类加载器通常被称为**系统类加载器**。当然我们也可以通过继承`ClassLoader`基类来自定义类加载器。
通过不同的类加载器，可以从不同来源来加载二进制数据，通常有以下几种来源。
- 从本地文件系统加载class文件。
- 从JAR包中加载class文件。
- 通过网络加载class文件。
- 把一个Java源文件动态编译，并执行加载。

**PS**:类加载器通常并不是要等到某个类首次被使用时才开始加载该类，在很多情况下Java虚拟机规范允许系统预加载某些类。

### 类的连接
当类被加载后，系统就会为之生成一个对应的Class对象，接着就会进入连接阶段，连接阶段负责把类的二进制数据合并到JRE（JRE是Java Runtime Enviroment是指Java的运行环境，是面向Java程序的使用者，而不是开发者。）中。类连接又可以分为如下三个阶段。
1. 验证，检查被加载的类是否有正确的内部结构，并和其它类协调一致。
2. 准备，为类的类变量分配内存，并设置默认初始值。
3. 解析，将类的二进制数据中的符号引用替换成直接引用。

### 类的初始化
在这一阶段，虚拟机负责对类进行初始化，主要是对类变量进行初始化。在Java类中对类变量指定初始值有两种方式：
1. 声明类变量时指定初始值。
2. 使用静态初始化代码块为类变量指定初始值。
JVM初始化一个类包含如下几个步骤。
1. 假如这个类还没有被加载和连接，则程序就会先加载并连接该类。
2. 假如该类的直接父类还没有被初始化，则先初始化直接父类。**PS**:直接父类的初始化同样遵守JVM初始化一个类的几个步骤。
3. 假如类中有初始化语句，则系统依次执行这些初始化语句。

### 类初始化的时期
当Java程序首次动过下面6种方式来使用某个类或接口时，系统就会初始化该类或接口。
1. 创建类的实例。为某个类创建实例的方式包括：使用new关键字来创建实例，通过反射来创建实例，通过反序列化的方式来创建实例。
2. 调用某个类的类方法（静态方法）。
3. 访问某个类或接口的类变量，或为该类变量赋值。
4. 使用反射方式来强制创建某个类或接口对应的`java.lang.Class`对象。例如代码`class.forName("Person")`，如果系统还未初始化Person类，则这行代码将导致Person类被初始化，并返回Person类对应的`java.lang.Class`对象。
5. 初始化某个类的子类。当初始化某个类的子类时，该子类的所有父类都会被初始化。
6. 直接使用java.exe命令来运行某个主类，程序会先初始化该主类。

除此之外，下面几种情况需要特别指出。
- 对于一个final修饰的类变量，如果该类能在编译时期就可以确定下来，那么这个类变量相当于一个宏变量（常量），因此即使在程序中使用该静态类变量也不会导致类的初始化。
- 当使用ClassLoader类的loadClass()方法来加载某个类时，该方法只加载该类，并不会执行该类的初始化。
